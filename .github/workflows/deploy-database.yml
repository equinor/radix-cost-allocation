name: Deploy Database

on:
  push:
    branches: [master, release]
permissions:
  id-token: write

jobs:

  deploy:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: "dev"
            ref: "refs/heads/master"
            client-id: "ca1b702f-a561-43b8-973a-c8b23a874d63"
            server: "sql-radix-cost-allocation-dev.database.windows.net"

          - name: "playground"
            ref: "refs/heads/release"
            client-id: "edb80ab7-4eb8-4477-a4e0-d42ec881b43d"
            server: "sql-radix-cost-allocation-playground.database.windows.net"

          - name: "platform"
            ref: "refs/heads/release"
            client-id: "to be decided" #FIXME
            server: "sql-radix-cost-allocation-prod.database.windows.net"

          - name: "c2"
            ref: "refs/heads/release"
            client-id: "to be decided" #FIXME
            server: "sql-radix-cost-allocation-c2-prod.database.windows.net"

    env:
      connection: >-
        Server=${{matrix.target.server}};
        Initial Catalog=radix-vulnerability-scan;
        Authentication=Active Directory Default; 
        Encrypt=True;
        TrustServerCertificate=False;
        Connection Timeout=30;

    steps:
      - uses: actions/checkout@v4
        if: matrix.target.run == github.ref

      - uses: azure/login@v1
        if: matrix.target.run == github.ref
        with:
          client-id: ${{matrix.target.client-id}}
          tenant-id: "3aa4a235-b6e2-48d5-9195-7fcf05b459b0"
          allow-no-subscriptions: true

      - uses: azure/sql-action@v2.2.1
        if: matrix.target.run == github.ref
        with:
          connection-string: ${{env.connection}}
          path: './azure-infrastructure/preDeployScript.sql'

      - uses: azure/sql-action@v2.2.1
        if: matrix.target.run == github.ref
        with:
          connection-string: ${{env.connection}}
          path: './azure-infrastructure/createSchema.sql'

      - uses: azure/sql-action@v2.2.1
        if: matrix.target.run == github.ref
        with:
          connection-string: ${{env.connection}}
          path: './azure-infrastructure/createTables.sql'

      - uses: azure/sql-action@v2.2.1
        if: matrix.target.run == github.ref
        with:
          connection-string: ${{env.connection}}
          path: './azure-infrastructure/createTypes.sql'

      - uses: azure/sql-action@v2.2.1
        if: matrix.target.run == github.ref
        with:
          connection-string: ${{env.connection}}
          path: './azure-infrastructure/createProcedures.sql'
